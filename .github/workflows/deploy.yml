name: Build and Deploy to S3

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  DOTNET_VERSION: '8.0.x'
  S3_BUCKET: 'medipanda'
  S3_PREFIX: 'app/windows/admin-app'
  AWS_REGION: 'ap-northeast-2'
  CLOUDFRONT_DOMAIN: 'cdn.medipanda.co.kr'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Find .csproj file
      id: find_csproj
      run: |
        $csprojFile = Get-ChildItem -Recurse -Filter "*.csproj" | Select-Object -First 1
        $csprojDir = $csprojFile.Directory.FullName
        $csprojName = $csprojFile.Name
        $csprojFull = $csprojFile.FullName
        
        echo "CSPROJ_DIR=$csprojDir" >> $env:GITHUB_OUTPUT
        echo "CSPROJ_NAME=$csprojName" >> $env:GITHUB_OUTPUT
        echo "CSPROJ_FULL=$csprojFull" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: Extract version from tag
      id: get_version
      run: |
        $version = "${{ github.ref }}" -replace 'refs/tags/v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: Update project version
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $csprojPath = "${{ steps.find_csproj.outputs.CSPROJ_FULL }}"
        
        $csproj = Get-Content $csprojPath -Raw
        
        if ($csproj -notmatch '<Version>') {
          $csproj = $csproj -replace '(</PropertyGroup>)', "    <Version>$version</Version>`n    <AssemblyVersion>$version.0</AssemblyVersion>`n    <FileVersion>$version.0</FileVersion>`n  `$1"
        } else {
          if ($csproj -match '<Version>') {
            $csproj = $csproj -replace '<Version>.*</Version>', "<Version>$version</Version>"
          }
          if ($csproj -notmatch '<AssemblyVersion>') {
            $csproj = $csproj -replace '(<Version>.*</Version>)', "`$1`n    <AssemblyVersion>$version.0</AssemblyVersion>"
          } else {
            $csproj = $csproj -replace '<AssemblyVersion>.*</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
          }
          if ($csproj -notmatch '<FileVersion>') {
            $csproj = $csproj -replace '(<AssemblyVersion>.*</AssemblyVersion>)', "`$1`n    <FileVersion>$version.0</FileVersion>"
          } else {
            $csproj = $csproj -replace '<FileVersion>.*</FileVersion>', "<FileVersion>$version.0</FileVersion>"
          }
        }
        
        Set-Content $csprojPath $csproj -Encoding UTF8
      shell: pwsh
    
    - name: Create AppConfig.cs
      run: |
        $csprojDir = "${{ steps.find_csproj.outputs.CSPROJ_DIR }}"
        $appConfigPath = "$csprojDir\AppConfig.cs"
        
        $content = @"
        namespace medipanda_windows_admin
        {
            public static class AppConfig
            {
                public const string AwsAccessKeyId = "${{ secrets.AWS_ACCESS_KEY_ID }}";
                public const string AwsSecretAccessKey = "${{ secrets.AWS_SECRET_ACCESS_KEY }}";
                private static bool _isDevMode = false;
                public static bool IsDevMode
                {
                    get => _isDevMode;
                    set => _isDevMode = value;
                }
                public static string GetBaseUrl()
                {
                    return _isDevMode
                        ? "https://dev.api.medipanda.co.kr"
                        : "https://prod.api.medipanda.co.kr";
                }
            }
        }
        "@
        
        Set-Content -Path $appConfigPath -Value $content -Encoding UTF8
        Write-Host "Created AppConfig.cs at $appConfigPath"
      shell: pwsh
    
    - name: Restore dependencies
      working-directory: ${{ steps.find_csproj.outputs.CSPROJ_DIR }}
      run: dotnet restore ${{ steps.find_csproj.outputs.CSPROJ_NAME }}
    
    - name: Build
      working-directory: ${{ steps.find_csproj.outputs.CSPROJ_DIR }}
      run: dotnet build ${{ steps.find_csproj.outputs.CSPROJ_NAME }} -c Release --no-restore
    
    - name: Publish (Self-Contained with .NET Runtime)
      working-directory: ${{ steps.find_csproj.outputs.CSPROJ_DIR }}
      run: |
        dotnet publish ${{ steps.find_csproj.outputs.CSPROJ_NAME }} `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -o ${{ github.workspace }}/publish `
          --no-build
        
        Write-Host "=== Published files ==="
        Get-ChildItem ${{ github.workspace }}/publish
      shell: pwsh
    
    - name: Create version.json
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $downloadUrl = "https://${{ env.CLOUDFRONT_DOMAIN }}/app/windows/admin-app/Medipanda-Setup-$version.exe"
        
        $versionInfo = @{
          version = $version
          downloadUrl = $downloadUrl
          isForceUpdate = $true
          releaseNotes = "Version $version released"
          releaseDate = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
        }
        
        $json = $versionInfo | ConvertTo-Json -Depth 10
        Set-Content -Path ./publish/version.json -Value $json -Encoding UTF8
      shell: pwsh
    
    - name: Create installer with Inno Setup
      run: |
        choco install innosetup -y
        
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $exeFile = Get-ChildItem -Path "./publish" -Filter "*.exe" | Select-Object -First 1
        $exeName = $exeFile.Name
        
        Write-Host "Found executable: $exeName"
        
        $setupScript = @"
        #define MyAppName "메디판다(관리자)"
        #define MyAppVersion "$version"
        #define MyAppPublisher "(주)케이앤메디슨"
        #define MyAppURL "https://medipanda.co.kr"
        #define MyAppExeName "$exeName"
        [Setup]
        AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567891}
        AppName={#MyAppName}
        AppVersion={#MyAppVersion}
        AppPublisher={#MyAppPublisher}
        AppPublisherURL={#MyAppURL}
        AppSupportURL={#MyAppURL}/support
        AppUpdatesURL={#MyAppURL}/downloads
        AppCopyright=Copyright © 2025 (주)케이앤메디슨
        DefaultDirName={autopf}\MedipandaAdmin
        DefaultGroupName={#MyAppName}
        DisableProgramGroupPage=yes
        OutputDir=.
        OutputBaseFilename=Medipanda-Setup-{#MyAppVersion}
        Compression=lzma2
        SolidCompression=yes
        ArchitecturesAllowed=x64
        ArchitecturesInstallIn64BitMode=x64
        PrivilegesRequired=lowest
        UninstallDisplayIcon={app}\{#MyAppExeName}
        WizardStyle=modern
        [Languages]
        Name: "korean"; MessagesFile: "compiler:Languages\Korean.isl"
        [Tasks]
        Name: "desktopicon"; Description: "바탕 화면에 바로 가기 만들기"; GroupDescription: "추가 작업:"; Flags: unchecked
        [Files]
        Source: "publish\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        [Icons]
        Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
        Name: "{group}\{#MyAppName} 제거"; Filename: "{uninstallexe}"
        Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
        [Run]
        Filename: "{app}\{#MyAppExeName}"; Description: "{#MyAppName} 실행"; Flags: nowait postinstall skipifsilent
        [UninstallDelete]
        Type: filesandordirs; Name: "{app}"
        "@
        
        $utf8Bom = New-Object System.Text.UTF8Encoding $true
        [System.IO.File]::WriteAllText("$PWD\setup.iss", $setupScript, $utf8Bom)
        
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Inno Setup compilation failed!"
          exit 1
        }
        
        Write-Host "=== Installer created ==="
        Get-ChildItem *.exe
      shell: pwsh
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Upload to S3
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $installerFile = "Medipanda-Setup-$version.exe"
        $s3Base = "s3://${{ env.S3_BUCKET }}/${{ env.S3_PREFIX }}/"
        
        aws s3 cp $installerFile "${s3Base}${installerFile}" --cache-control "max-age=300"
        aws s3 cp ./publish/version.json "${s3Base}version.json" --content-type "application/json" --cache-control "no-cache, no-store, must-revalidate"
        aws s3 cp $installerFile "${s3Base}setup.exe" --cache-control "max-age=300"
        
        Write-Host "=== Deployment Complete ==="
      shell: pwsh
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: Medipanda-Setup-${{ steps.get_version.outputs.VERSION }}.exe
        body: |
          ## 메디판다(관리자) v${{ steps.get_version.outputs.VERSION }}
          
          ### 다운로드
          [설치 파일 다운로드](https://${{ env.CLOUDFRONT_DOMAIN }}/app/windows/admin-app/setup.exe)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}